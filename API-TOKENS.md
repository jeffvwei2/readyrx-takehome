# API Token Authentication

## Overview
The ReadyRx application uses API tokens instead of traditional username/password authentication. This provides a simpler, more secure way to manage access to the system.

## How It Works

### 1. Token Generation
- API tokens are generated by administrators
- Each token has a specific role (admin, doctor, lab_tech, patient)
- Tokens are long-lived (365 days) but can be revoked immediately

### 2. Token Usage
- Users enter their assigned API token in the sidebar
- The token is automatically used for all API calls
- No password management or session handling required

### 3. Role-Based Access
- **Admin**: Full system access + token management
- **Doctor**: Patient data, lab orders, results
- **Lab Tech**: Lab orders, results, file uploads
- **Patient**: Own data only

## Getting Started

### 1. Start the Backend
```bash
cd backend && npm run dev
```

### 2. Check Console Output
The system automatically creates default tokens:
```
ðŸ”‘ API tokens created successfully:
   Admin Token (admin): eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   Doctor Token (doctor): eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   Lab Tech Token (lab_tech): eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   Patient Token (patient): eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 3. Use Tokens in Frontend
1. Open the ReadyRx frontend
2. Look for the "API Access" section in the sidebar
3. Click "Enter Token"
4. Paste your assigned token
5. Click "Connect"

### 4. Alternative: Generate Custom Tokens
```bash
# Generate tokens for testing
node generate-tokens.js
```

## Token Management

### Admin Functions
Admins can manage tokens via API:
```bash
# Create new token
curl -X POST http://localhost:5000/api/auth/tokens \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Doctor Token", "role": "doctor"}'

# List all tokens
curl -H "Authorization: Bearer ADMIN_TOKEN" \
  http://localhost:5000/api/auth/tokens

# Revoke token
curl -X DELETE http://localhost:5000/api/auth/tokens/TOKEN_ID \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### Token Information
```bash
# Get current token info
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/auth/info
```

## Security Features

### Token Security
- **JWT-based**: Secure token format
- **Role-based**: Granular permissions
- **Revocable**: Can be disabled immediately
- **Audited**: All token usage is logged

### Data Protection
- **Encrypted Storage**: Sensitive data encrypted at rest
- **Input Validation**: All inputs validated and sanitized
- **Audit Logging**: Complete access trail
- **Rate Limiting**: DDoS protection

## Troubleshooting

### Common Issues

#### "Invalid API token" Error
- Check that the token is copied correctly
- Ensure the token hasn't been revoked
- Verify the backend is running

#### "Insufficient permissions" Error
- Check your token's role
- Ensure you have permission for the requested action
- Contact admin if you need different permissions

#### Token Not Working
- Try logging out and re-entering the token
- Check browser console for errors
- Verify backend is accessible

### Getting Help
- Check the console output for token creation
- Review the SECURITY.md file for detailed information
- Contact your administrator for token issues

## Best Practices

### For Users
- Store tokens securely (not in code or config files)
- Don't share tokens with others
- Log out when finished
- Report suspicious activity

### For Administrators
- Rotate tokens regularly (6-12 months)
- Revoke unused tokens immediately
- Monitor token usage patterns
- Use least privilege principle

## API Examples

### Using Tokens in API Calls
```bash
# Get patients
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/patients

# Create lab order
curl -X POST http://localhost:5000/api/lab-orders \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test Order", "patientId": "123", ...}'

# Upload file
curl -X POST http://localhost:5000/api/parsers/parse \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"data": "file content", ...}'
```

### Frontend Integration
The frontend automatically includes the token in all API calls:
```javascript
// Token is automatically added to axios requests
axios.get('/api/patients'); // Includes Authorization header
```
